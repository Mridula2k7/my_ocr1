<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OCR Mobile Pro</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg-dark:#071125; --panel:#0f1724; --muted:#9fb1c9; --accent:#2d9cff;
  --bg-light:#f1f5f9; --text-light:#042a3a; --panel-light:#fff; --muted-light:#7b7b7b; --accent-light:#2d9cff;
}
body{
  margin:0;font-family:Inter,Segoe UI,Arial;
  background:var(--bg-dark);color:#e6f7ff;
  overflow-x:hidden;
}
body.light{background:var(--bg-light);color:var(--text-light);}
.container{width:100%;max-width:480px;margin:auto;padding:12px;display:flex;flex-direction:column;gap:12px;}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);}
body.light .card{background:var(--panel-light);border:1px solid rgba(0,0,0,0.08);}
input,textarea,button{font-family:inherit;font-size:14px}
textarea{width:100%;min-height:140px;margin-top:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6f7ff;resize:none;}
body.light textarea{border:1px solid rgba(0,0,0,0.08);color:var(--text-light);background:#fefefe;}
button{border:0;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;}
button.primary{background:linear-gradient(90deg,var(--accent),#6ee8d5);color:#042a3a;margin-top:8px;}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#cfeeff;margin-top:8px;width:100%;}
body.light button.ghost{border:1px solid rgba(0,0,0,0.08);color:var(--text-light);}
#preview{width:100%;max-height:300px;object-fit:contain;border-radius:8px;display:none;margin-top:8px;}
#toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#042a3a;color:#bff;padding:10px 14px;border-radius:8px;display:none;z-index:9999;}
body.light #toast{background:#e6f7ff;color:#042a3a;}
#loader{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:12px;border-radius:8px;z-index:999;}
.history-item{display:flex;gap:8px;align-items:flex-start;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-top:6px;flex-direction:column;}
body.light .history-item{background:rgba(0,0,0,0.03);}
.muted{color:var(--muted);font-size:13px;}
body.light .muted{color:var(--muted-light);}
input[type=file]{display:none;}
</style>
</head>
<body>
<div id="loader">OCR in progress...</div>
<div id="toast">Saved âœ”</div>

<div class="container">

  <div class="card">
    <h2>OCR Scanner</h2>
    <div class="muted">Upload image or capture via camera</div>

    <label class="ghost" style="cursor:pointer;width:100%;text-align:center;">Upload Image
      <input type="file" id="fileInput" accept="image/*" multiple>
    </label>

    <button class="ghost" id="openCam">Open Camera</button>
    <button class="ghost" id="captureBtn" style="display:none">Capture</button>
    <button class="ghost" id="switchCam">Front / Rear</button>
    <img id="preview" alt="preview">

    <textarea id="ocrText" placeholder="OCR result will appear here"></textarea>

    <button class="primary" id="btnOCR">Extract Text</button>
    <button class="ghost" id="btnTxt">Download TXT</button>
    <button class="ghost" id="btnPDF">Export PDF</button>
    <button class="ghost" id="btnSave">Save to Firebase</button>
    <button class="ghost" id="btnClear">Clear</button>
    <button class="ghost" id="themeBtn">Toggle Theme</button>
  </div>

  <div class="card">
    <h3>History</h3>
    <input id="searchText" placeholder="Search text..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <button class="ghost" id="btnRefresh">Refresh</button>
    <div id="historyList">Loading history...</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, addDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD69D9mpeIdbGTWVKTlb7QD0EQdE3p7KSM",
  authDomain: "my-ocr-c7d74.firebaseapp.com",
  projectId: "my-ocr-c7d74",
  storageBucket: "my-ocr-c7d74.appspot.com",
  messagingSenderId: "306025938236",
  appId: "1:306025938236:web:3c95f72627c89f87f6f239",
  measurementId: "G-9N780BCMPZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* --- UI refs --- */
const fileInput=document.getElementById('fileInput');
const openCam=document.getElementById('openCam');
const captureBtn=document.getElementById('captureBtn');
const switchCam=document.getElementById('switchCam');
const preview=document.getElementById('preview');
const btnOCR=document.getElementById('btnOCR');
const btnTxt=document.getElementById('btnTxt');
const btnPDF=document.getElementById('btnPDF');
const ocrText=document.getElementById('ocrText');
const btnSave=document.getElementById('btnSave');
const btnClear=document.getElementById('btnClear');
const themeBtn=document.getElementById('themeBtn');
const historyList=document.getElementById('historyList');
const btnRefresh=document.getElementById('btnRefresh');
const searchInput=document.getElementById('searchText');
const toast=document.getElementById('toast');
const loader=document.getElementById('loader');

let selectedBlobs=[]; let stream=null; let facingMode='environment';

/* --- Theme --- */
themeBtn.addEventListener('click',()=>document.body.classList.toggle('light'));

/* --- File Upload --- */
fileInput.addEventListener('change',e=>{
  const files=Array.from(e.target.files);
  if(!files.length)return;
  selectedBlobs=files;
  preview.src=URL.createObjectURL(files[0]);
  preview.style.display='block';
  ocrText.value='';
});

/* --- Camera --- */
openCam.addEventListener('click',async ()=>{
  try{
    if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    const v=document.createElement('video');
    v.autoplay=true; v.playsInline=true; v.muted=true;
    v.srcObject=stream; v.style.width='100%';
    preview.style.display='none';
    preview.parentNode.insertBefore(v,preview);
    captureBtn.style.display='inline-block';
    openCam.style.display='none';
    captureBtn.onclick=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=v.videoWidth||1280;
      canvas.height=v.videoHeight||720;
      canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>{
        selectedBlobs=[b];
        preview.src=URL.createObjectURL(b);
        preview.style.display='block';
        v.remove();
        stream.getTracks().forEach(t=>t.stop()); stream=null;
        captureBtn.style.display='none'; openCam.style.display='inline-block';
        ocrText.value='';
      },'image/jpeg',0.95);
    };
  }catch(err){alert('Camera error: '+err.message);}
});

switchCam.addEventListener('click',()=>{
  facingMode=(facingMode==='environment')?'user':'environment';
  if(stream){
    stream.getTracks().forEach(t=>t.stop()); stream=null;
    const v=document.querySelector('video'); if(v)v.remove();
    captureBtn.style.display='none'; openCam.style.display='inline-block';
    openCam.click();
  }
});

/* --- OCR --- */
async function performOCR(blob){
  loader.style.display='block';
  const { data }=await Tesseract.recognize(blob,'eng',{logger:m=>{}});
  loader.style.display='none';
  ocrText.value=data.text.trim();
}

btnOCR.addEventListener('click',async ()=>{
  if(!selectedBlobs.length)return alert('Select or capture image first');
  for(const b of selectedBlobs) await performOCR(b);
});

/* --- Save to Firebase --- */
btnSave.addEventListener('click',async ()=>{
  const text=ocrText.value.trim();
  if(!text)return alert('No OCR text');
  let imgData='';
  try{
    if(preview.src){
      const r=await fetch(preview.src);
      const blob=await r.blob();
      imgData=await blobToDataURL(blob);
    }
  }catch(e){console.warn(e);}
  try{
    await addDoc(collection(db,'ocr_records'),{text,image:imgData,createdAt:new Date().toISOString()});
    showToast('Saved to Firebase');
    loadHistory();
  }catch(e){alert('Save failed: '+e.message);}
});

btnClear.addEventListener('click',()=>{
  selectedBlobs=[]; preview.src=''; preview.style.display='none'; ocrText.value='';
});

/* --- Download TXT --- */
btnTxt.addEventListener('click',()=>{
  const text=ocrText.value.trim(); if(!text)return alert('No text to download');
  const blob=new Blob([text],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ocr.txt'; a.click(); URL.revokeObjectURL(a.href);
});

/* --- Export PDF --- */
btnPDF.addEventListener('click',()=>{
  const text=ocrText.value.trim(); if(!text)return alert('No text to export');
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  const lines=doc.splitTextToSize(text,180);
  doc.text(lines,10,10);
  doc.save('ocr.pdf');
});

/* --- History --- */
async function loadHistory(){
  historyList.innerHTML='Loading...';
  try{
    const q=query(collection(db,'ocr_records'),orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    const items=[];
    snap.forEach(d=>items.push(Object.assign({id:d.id},d.data())));
    if(items.length===0){historyList.innerHTML='<div class="muted">No records yet.</div>'}else{
      historyList.innerHTML='';
      const searchVal=searchInput.value.toLowerCase();
      items.filter(it=>it.text.toLowerCase().includes(searchVal)).forEach(it=>{
        const node=document.createElement('div'); node.className='history-item';
        if(it.image){const img=document.createElement('img'); img.src=it.image; img.style.width='100%'; img.style.borderRadius='6px'; node.appendChild(img);}
        const div=document.createElement('div');
        div.innerHTML=`<div class="muted">${new Date(it.createdAt).toLocaleString()}</div><div>${it.text.substring(0,180)}</div>`;
        node.appendChild(div);
        historyList.appendChild(node);
      });
    }
  }catch(e){historyList.innerHTML='Error loading history: '+e.message;}
}
btnRefresh.addEventListener('click',loadHistory);
searchInput.addEventListener('input',loadHistory);

/* --- Toast --- */
function showToast(msg){toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2000);}
function blobToDataURL(blob){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob);})}
</script>
</body>
</html>
