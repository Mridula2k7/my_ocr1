<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced OCR Scanner App</title>

<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; padding:0; text-align:center; }
nav { display:flex; justify-content:space-around; background:#1e293b; padding:12px; position:sticky; top:0; z-index:10; }
nav button { background:#3b82f6; border:none; color:white; padding:10px 16px; border-radius:6px; cursor:pointer; }

.page { display:none; padding:20px; }
.active { display:block; }

.inputBar {
    width:90%; padding:10px; margin-top:10px;
    border-radius:8px; border:none;
}

#preview, #cameraPreview { width:90%; max-width:330px; border-radius:10px; margin-top:15px; }
#resultBox { margin-top:20px; background:#1e293b; padding:15px; border-radius:10px; white-space:pre-wrap; }

.historyItem {
    background:#1e293b; padding:14px; border-radius:10px;
    margin:10px; text-align:left;
}

#savePopup {
    position:fixed; bottom:20px; right:20px;
    background:#4caf50; color:white;
    padding:12px 18px; border-radius:8px;
    display:none; font-size:16px;
}

</style>
</head>
<body>

<nav>
    <button onclick="showPage('homePage')">Home</button>
    <button onclick="showPage('scanPage')">Scan</button>
    <button onclick="showPage('historyPage')">History</button>
</nav>

<!-- HOME -->
<div id="homePage" class="page active">
    <h1>ðŸ“„ Advanced OCR Scanner</h1>
    <p>Upload / Capture â†’ OCR â†’ AI Summary â†’ Save â†’ Export â†’ History</p>
</div>

<!-- SCAN PAGE -->
<div id="scanPage" class="page">
    <h2>ðŸ“· Scan Document</h2>

    <input type="file" id="fileInput" accept="image/*" class="inputBar">

    <button onclick="openCamera('environment')">ðŸ“¸ Rear Camera</button>
    <button onclick="openCamera('user')">ðŸ¤³ Front Camera</button>

    <video id="cameraPreview" autoplay playsinline style="display:none;"></video>
    <canvas id="cameraCanvas" style="display:none;"></canvas>

    <img id="preview" style="display:none;">
    <button onclick="startOCR()" class="inputBar">Extract Text</button>

    <div id="resultBox" style="display:none;"></div>
    <button id="summaryBtn" style="display:none;" onclick="generateSummary()">âœ¨ Generate Summary</button>
    <button id="pdfBtn" style="display:none;" onclick="exportPDF()">ðŸ“„ Export PDF</button>
    <button id="speakBtn" style="display:none;" onclick="speakText()">ðŸ”Š Read Aloud</button>
</div>

<!-- HISTORY PAGE -->
<div id="historyPage" class="page">
    <h2>ðŸ“š OCR History</h2>
    <input type="text" id="searchBar" class="inputBar" placeholder="Search text..." oninput="filterHistory()">
    <div id="historyList">Loading...</div>
</div>

<div id="savePopup">Saved to Firebase!</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCh_IRxmDB8FN10HAAsB56KTX_SwZs28wM",
  authDomain: "fir-9a78e.firebaseapp.com",
  projectId: "fir-9a78e",
  storageBucket: "fir-9a78e.firebasestorage.app",
  messagingSenderId: "510654220450",
  appId: "1:510654220450:web:4ef133128704aba04ceffb",
  measurementId: "G-QDCXL58VDZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// SAVE TO FIREBASE
window.saveToFirebase = async function(text){
    if(!text) return;
    await addDoc(collection(db, "ocr_texts"), {
        text: text,
        time: new Date()
    });
    showPopup();
    loadHistory();
};

// LOAD HISTORY
window.loadHistory = async function(){
    const list = document.getElementById("historyList");
    list.innerHTML = "Loading...";
    const q = query(collection(db, "ocr_texts"), orderBy("time","desc"));
    const querySnapshot = await getDocs(q);

    let html="";
    querySnapshot.forEach(doc => {
        html += `<div class="historyItem">${doc.data().text}</div>`;
    });

    list.innerHTML = html || "No history found.";
};
loadHistory();
</script>

<script>
function showPage(id){
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function showPopup(){
    const p=document.getElementById("savePopup");
    p.style.display="block";
    setTimeout(()=>p.style.display="none",3000);
}

let selectedImage=null;
const preview=document.getElementById("preview");
const fileInput=document.getElementById("fileInput");

fileInput.addEventListener("change",()=>{
    selectedImage=fileInput.files[0];
    preview.src=URL.createObjectURL(selectedImage);
    preview.style.display="block";
});

let stream=null;

// CAMERA OPEN
async function openCamera(facingMode){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode } });
    const video=document.getElementById("cameraPreview");
    video.srcObject=stream;
    video.style.display="block";
    video.onclick=captureFromCamera;
}

// CAPTURE
function captureFromCamera(){
    const video=document.getElementById("cameraPreview");
    const canvas=document.getElementById("cameraCanvas");
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    canvas.toBlob(blob=>{
        selectedImage=blob;
        preview.src=URL.createObjectURL(blob);
        preview.style.display="block";
    });
    video.style.display="none";
    stream.getTracks().forEach(track=>track.stop());
}

// OCR
async function startOCR(){
    if(!selectedImage){ alert("Upload or capture an image first!"); return; }
    const resultBox=document.getElementById("resultBox");
    resultBox.style.display="block";
    resultBox.innerText="Processing...";

    const worker = await Tesseract.createWorker();
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');

    const { data:{ text } } = await worker.recognize(selectedImage);
    resultBox.innerText=text;
    await worker.terminate();

    saveToFirebase(text);

    document.getElementById("summaryBtn").style.display="block";
    document.getElementById("pdfBtn").style.display="block";
    document.getElementById("speakBtn").style.display="block";
}

// SUMMARY
function generateSummary(){
    const text=document.getElementById("resultBox").innerText;
    const sentences=text.split(". ");
    let summary="";

    for(let i=0;i<Math.min(3,sentences.length);i++){
        summary+=sentences[i]+". ";
    }
    alert("âœ¨ Summary:\n\n" + summary);
}

// EXPORT PDF
function exportPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text(document.getElementById("resultBox").innerText,10,10);
    pdf.save("OCR_Text.pdf");
}

// SPEAK
function speakText(){
    const msg=new SpeechSynthesisUtterance(document.getElementById("resultBox").innerText);
    speechSynthesis.speak(msg);
}

// SEARCH FILTER
function filterHistory(){
    const input=document.getElementById("searchBar").value.toLowerCase();
    const items=document.querySelectorAll('.historyItem');
    items.forEach(item=>{
        item.style.display=item.innerText.toLowerCase().includes(input) ? "block" : "none";
    });
}

</script>

</body>
</html>


