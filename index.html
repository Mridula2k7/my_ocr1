<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OCR Pro — Dashboard + Camera + PDF</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg-dark:#071125; --panel:#0f1724; --muted:#9fb1c9; --accent:#2d9cff;
  --bg-light:#f1f5f9; --text-light:#042a3a; --panel-light:#fff; --muted-light:#7b7b7b; --accent-light:#2d9cff;
}
body{
  margin:0;font-family:Inter,Segoe UI,Arial;
  background:var(--bg-dark);color:#e6f7ff;
}
body.light{
  background:var(--bg-light);color:var(--text-light);
}
.layout{display:flex;min-height:100vh}
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#07102a,#071125);
  padding:18px;border-right:1px solid rgba(255,255,255,0.03);
}
body.light .sidebar{background:var(--panel-light);border-color:rgba(0,0,0,0.08);color:var(--text-light);}
.brand{font-weight:800;font-size:18px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
body.light .small{color:var(--muted-light);}
.menu{margin-top:18px;display:flex;flex-direction:column;gap:8px}
.menu button{
  background:transparent;border:0;color:#cfeeff;padding:10px;border-radius:8px;text-align:left;cursor:pointer
}
body.light .menu button{color:var(--text-light);}
.menu button.active{background:linear-gradient(90deg,var(--accent),#6ee8d5);color:#042a3a}
.content{flex:1;padding:20px}
.topbar{display:flex;justify-content:space-between;align-items:center}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);margin-top:14px;
}
body.light .card{background:var(--panel-light);border:1px solid rgba(0,0,0,0.08);}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button.primary{
  background:linear-gradient(90deg,var(--accent),#6ee8d5);
  border:0;padding:10px 12px;border-radius:8px;color:#042a3a;font-weight:700;cursor:pointer
}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:9px 12px;border-radius:8px;color:#cfeeff;cursor:pointer}
body.light button.ghost{border:1px solid rgba(0,0,0,0.08);color:var(--text-light);}
#preview{width:100%;max-height:420px;object-fit:contain;border-radius:10px;margin-top:12px;display:none;position:relative;}
#bboxCanvas{position:absolute;top:0;left:0;pointer-events:none;}
textarea{width:100%;min-height:140px;margin-top:12px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6f7ff}
body.light textarea{border:1px solid rgba(0,0,0,0.08);color:var(--text-light);background:#fefefe;}
#toast{position:fixed;right:18px;bottom:18px;background:#042a3a;color:#bff; padding:10px 14px;border-radius:8px;display:none;z-index:9999}
body.light #toast{background:#e6f7ff;color:#042a3a;}
.row{display:flex;gap:8px;align-items:center}
.history-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-top:8px}
body.light .history-item{background:rgba(0,0,0,0.03);}
.history-thumb{width:120px;height:80px;object-fit:cover;border-radius:6px}
.muted{color:var(--muted);font-size:13px}
body.light .muted{color:var(--muted-light);}
#loader{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999;background:rgba(0,0,0,0.5);color:white;padding:12px;border-radius:8px;}
@media(max-width:900px){ .sidebar{display:none} .content{padding:12px} }
</style>
</head>
<body>
<div id="toast">Saved ✔</div>
<div id="loader">OCR in progress...</div>
<div class="layout">
  <aside class="sidebar">
    <div class="brand">OCR Pro</div>
    <div class="small">Scan • OCR • History • PDF</div>
    <div class="menu" role="tablist">
      <button class="active" data-screen="scan">Scanner</button>
      <button data-screen="history">History</button>
      <button data-screen="settings">Settings</button>
    </div>
    <div style="margin-top:18px">
      <button id="themeBtn" class="ghost" style="margin-top:8px">Toggle Theme</button>
    </div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div>
        <h2 style="margin:0">Scanner</h2>
        <div class="muted">Upload or capture image — OCR powered by Tesseract</div>
      </div>
    </div>

    <section id="screen-scan" class="card">
      <div class="row">
        <label class="ghost" style="cursor:pointer">
          Upload
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
        </label>
        <button id="openCam" class="ghost">Open Camera</button>
        <button id="captureBtn" class="ghost" style="display:none">Capture</button>
        <button id="switchCam" class="ghost">Front / Rear</button>
        <button id="btnOCR" class="primary">Extract Text</button>
        <button id="btnTxt" class="ghost">Download TXT</button>
        <button id="btnPDF" class="ghost">Export PDF</button>
      </div>

      <div style="position:relative;margin-top:12px">
        <img id="preview" alt="preview">
        <canvas id="bboxCanvas"></canvas>
      </div>

      <div style="margin-top:12px">
        <textarea id="ocrText" placeholder="Extracted text will appear here..."></textarea>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnSave" class="ghost">Save</button>
        <button id="btnClear" class="ghost">Clear</button>
      </div>
    </section>

    <section id="screen-history" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3 style="margin:0">History</h3><div class="muted">Saved scans</div></div>
        <div>
          <button id="btnRefresh" class="ghost">Refresh</button>
        </div>
      </div>
      <input id="searchText" placeholder="Search text..." style="margin-top:8px;width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <div id="historyList" style="margin-top:12px">Loading history...</div>
    </section>

    <section id="screen-settings" class="card" style="display:none">
      <h3 style="margin-top:0">Settings</h3>
      <div class="muted">Firebase settings are fixed</div>
    </section>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, addDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD69D9mpeIdbGTWVKTlb7QD0EQdE3p7KSM",
  authDomain: "my-ocr-c7d74.firebaseapp.com",
  projectId: "my-ocr-c7d74",
  storageBucket: "my-ocr-c7d74.appspot.com",
  messagingSenderId: "306025938236",
  appId: "1:306025938236:web:3c95f72627c89f87f6f239",
  measurementId: "G-9N780BCMPZ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* --- UI refs --- */
const fileInput = document.getElementById('fileInput');
const openCam = document.getElementById('openCam');
const captureBtn = document.getElementById('captureBtn');
const switchCam = document.getElementById('switchCam');
const preview = document.getElementById('preview');
const bboxCanvas = document.getElementById('bboxCanvas');
const btnOCR = document.getElementById('btnOCR');
const btnSave = document.getElementById('btnSave');
const btnClear = document.getElementById('btnClear');
const btnTxt = document.getElementById('btnTxt');
const btnPDF = document.getElementById('btnPDF');
const ocrText = document.getElementById('ocrText');
const toast = document.getElementById('toast');
const loader = document.getElementById('loader');

const menuBtns = document.querySelectorAll('.menu button');
const screenScan = document.getElementById('screen-scan');
const screenHistory = document.getElementById('screen-history');
const screenSettings = document.getElementById('screen-settings');
const historyList = document.getElementById('historyList');
const btnRefresh = document.getElementById('btnRefresh');
const themeBtn = document.getElementById('themeBtn');
const searchInput = document.getElementById('searchText');

let selectedBlobs = [];
let stream = null;
let facingMode = 'environment';

/* --- Navigation --- */
menuBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    menuBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const screen = b.dataset.screen;
    screenScan.style.display = screen==='scan' ? '' : 'none';
    screenHistory.style.display = screen==='history' ? '' : 'none';
    screenSettings.style.display = screen==='settings' ? '' : 'none';
    if(screen==='history') loadHistory();
  });
});

/* --- Theme --- */
themeBtn.addEventListener('click', ()=> document.body.classList.toggle('light'));

/* --- File Upload --- */
fileInput.addEventListener('change', e=>{
  const files = Array.from(e.target.files);
  if(!files.length) return;
  selectedBlobs = files;
  preview.src = URL.createObjectURL(files[0]);
  preview.style.display='block';
  ocrText.value='';
  bboxCanvas.getContext('2d').clearRect(0,0,bboxCanvas.width,bboxCanvas.height);
});

/* --- Camera --- */
openCam.addEventListener('click', async ()=>{
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null;}
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    const v = document.createElement('video');
    v.autoplay=true; v.playsInline=true; v.muted=true;
    v.srcObject=stream;
    v.style.width=preview.clientWidth+'px';
    preview.style.display='none';
    preview.parentNode.insertBefore(v, preview);
    captureBtn.style.display='inline-block';
    openCam.style.display='none';
    captureBtn.onclick=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=v.videoWidth||1280;
      canvas.height=v.videoHeight||720;
      canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>{
        selectedBlobs=[b];
        preview.src = URL.createObjectURL(b);
        preview.style.display='block';
        v.remove();
        stream.getTracks().forEach(t=>t.stop()); stream=null;
        captureBtn.style.display='none';
        openCam.style.display='inline-block';
        ocrText.value='';
        bboxCanvas.getContext('2d').clearRect(0,0,bboxCanvas.width,bboxCanvas.height);
      },'image/jpeg',0.95);
    };
  }catch(err){alert('Camera error: '+err.message);}
});

switchCam.addEventListener('click', ()=>{
  facingMode=(facingMode==='environment')?'user':'environment';
  if(stream){
    stream.getTracks().forEach(t=>t.stop()); stream=null;
    const v=document.querySelector('video'); if(v)v.remove();
    captureBtn.style.display='none'; openCam.style.display='inline-block'; openCam.click();
  }
});

/* --- OCR with bounding boxes --- */
async function performOCR(blob){
  loader.style.display='block';
  const { data } = await Tesseract.recognize(blob, 'eng', {logger: m=>{}});
  loader.style.display='none';
  ocrText.value = data.text.trim();
  drawBoundingBoxes(data);
}

function drawBoundingBoxes(data){
  const ctx=bboxCanvas.getContext('2d');
  const imgWidth=preview.naturalWidth;
  const imgHeight=preview.naturalHeight;
  bboxCanvas.width=preview.clientWidth;
  bboxCanvas.height=preview.clientHeight;
  ctx.clearRect(0,0,bboxCanvas.width,bboxCanvas.height);
  ctx.strokeStyle='red'; ctx.lineWidth=1.2;
  const scaleX=bboxCanvas.width/imgWidth;
  const scaleY=bboxCanvas.height/imgHeight;
  data.words.forEach(w=>{
    const x=w.bbox.x0*scaleX;
    const y=w.bbox.y0*scaleY;
    const wdt=(w.bbox.x1-w.bbox.x0)*scaleX;
    const hgt=(w.bbox.y1-w.bbox.y0)*scaleY;
    ctx.strokeRect(x,y,wdt,hgt);
  });
}

btnOCR.addEventListener('click', async ()=>{
  if(!selectedBlobs.length) return alert('Select/capture image first');
  for(const b of selectedBlobs){
    await performOCR(b);
  }
});

/* --- Save to Firebase --- */
btnSave.addEventListener('click', async ()=>{
  const text=ocrText.value.trim();
  if(!text) return alert('No OCR text');
  let imgData='';
  try{
    if(preview.src){
      const r=await fetch(preview.src);
      const blob=await r.blob();
      imgData=await blobToDataURL(blob);
    }
  }catch(e){console.warn('Image convert failed',e);}
  try{
    await addDoc(collection(db,'ocr_records'),{
      text,image:imgData,createdAt:new Date().toISOString()
    });
    showToast('Saved to Firebase');
    loadHistory();
  }catch(e){alert('Save failed: '+e.message);}
});

btnClear.addEventListener('click', ()=>{
  selectedBlobs=[]; preview.src=''; preview.style.display='none'; ocrText.value=''; bboxCanvas.getContext('2d').clearRect(0,0,bboxCanvas.width,bboxCanvas.height);
});

/* --- Download TXT --- */
btnTxt.addEventListener('click', ()=>{
  const text=ocrText.value.trim();
  if(!text) return alert('No text to download');
  const blob=new Blob([text],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ocr.txt'; a.click(); URL.revokeObjectURL(a.href);
});

/* --- Export PDF --- */
btnPDF.addEventListener('click', ()=>{
  const text=ocrText.value.trim();
  if(!text) return alert('No text to export');
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  const lines=doc.splitTextToSize(text,180);
  doc.text(lines,10,10);
  doc.save('ocr.pdf');
});

/* --- History --- */
async function loadHistory(){
  historyList.innerHTML='Loading...';
  try{
    const q=query(collection(db,'ocr_records'),orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    const items=[];
    snap.forEach(d=>items.push(Object.assign({id:d.id},d.data())));
    if(items.length===0) historyList.innerHTML='<div class="muted">No records yet.</div>';
    else{
      historyList.innerHTML='';
      const searchVal=searchInput.value.toLowerCase();
      items.filter(it=>it.text.toLowerCase().includes(searchVal)).forEach(it=>{
        const node=document.createElement('div'); node.className='history-item';
        const img=document.createElement('img'); img.className='history-thumb'; img.src=it.image||''; node.appendChild(img);
        const div=document.createElement('div');
        div.innerHTML=`<div class="muted">${new Date(it.createdAt).toLocaleString()}</div><div>${it.text.substring(0,180)}</div>`;
        node.appendChild(div);
        historyList.appendChild(node);
      });
    }
  }catch(e){historyList.innerHTML='Error loading history: '+e.message;}
}
btnRefresh.addEventListener('click', loadHistory);
searchInput.addEventListener('input', loadHistory);

/* --- Toast --- */
function showToast(msg){
  toast.textContent=msg; toast.style.display='block';
  setTimeout(()=>toast.style.display='none',2000);
}

/* --- Helpers --- */
function blobToDataURL(blob){ return new Promise(res=>{
  const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob);
})}
</script>
</body>
</html>
   



